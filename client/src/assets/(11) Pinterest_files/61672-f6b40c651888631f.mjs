"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([[61672],{859721:(e,a,t)=>{t.d(a,{Z:()=>l});var s=t(616550),r=t(798580),n=t(19447);function l(){let e=(0,n.S6)(),a=(0,s.TH)();return(t,s)=>{let n;let l=e(t);if(s?.shouldTrackForPrevLocation){let e=l?.tracking_params_map||{},a=Object.keys(e).find(e=>"PinResource"!==e);l&&(n=a?e[a]:e.PinResource)}else l&&(n=(0,r.Z)({boardUrl:l.board?.url,location:a,pinId:l.id,pinnerUserName:l.pinner?.username,storyPinDataId:l.story_pin_data_id,trackingParams:l.tracking_params,trackingParamsMap:l.tracking_params_map}));return n}}},161672:(e,a,t)=>{let s;t.d(a,{i5:()=>T,sX:()=>R,aX:()=>A,Z5:()=>S,NG:()=>f,MT:()=>D,iu:()=>m});var r=t(667294),n=t(216167),l=t(859721),o=t(342513),d=t(638747),i=t(996523);let u=(e,a)=>e.data[a]&&e.data[a].messages||[];function c(e,a){let t=new Map;for(let s of e){if(!s)continue;let e=a(s);if(t.has(e)){let a=(0,i.Z)(t.get(e),s);t.set(e,a)}else t.set(e,s)}return[...t.values()]}function E(e){return[...e].sort((e,a)=>new Date(e.created_ms||e.created_at).getTime()-new Date(a.created_ms||a.created_at).getTime())}function _(e,a,t){return E(c(u(e,a).concat(t),e=>e.id))}let p={conversationsUnseenCount:0,data:{},newsHubCount:0,open:null,objectAttachment:null,showConversationsDropdown:!1,showNewMessageView:!1,ui:{},unread:0};function y(e=p,a){if("CONVERSATION_OPEN"===a.type)return{...e,open:a.payload.id,objectAttachment:null,showNewMessageView:!1,ui:{...e.ui,[a.payload.id]:{contactRequestId:a.payload.contactRequestId||"",isPreview:a.payload.isPreview}}};if("CONVERSATION_CLOSE"===a.type)return{...e,open:null,objectAttachment:null,showNewMessageView:!1,ui:{...e.ui,[a.payload.id]:{contactRequestId:a.payload.contactRequestId||"",isPreview:!1,isDeclined:a.payload.isDeclined}}};if("CONVERSATION_CREATE"===a.type){let{id:t}=a.payload;return{...e,data:{...e.data,[t]:{...e.data[t]||{},...a.payload}}}}if("CONVERSATION_DELETE"===a.type){let t={...e,data:{...e.data}},{id:s}=a.payload;return delete t.data[s],t}if("FETCH_COMPLETE"===a.type){let{options:t,resource:s,response:r}=a.payload,n=r.resource_response.data;if("ConversationMessagesResource"===s){let a=n||[],s=t?.conversation_id||"",r=_(e,s,a),l=r[r.length-1];return{...e,data:{...e.data,[s]:{...e.data[s],id:s,messages:r,unread:0,last_message:l}}}}if("ConversationsResource"===s){let a=n||[],t={...e,data:{...e.data}};return a.forEach(e=>{let{id:a,created_at:s,name:r,board:n,emails:l,unread:o,users:d,last_message:i}=e,u=_(t,a,[i]);t.data[a]={...t.data[a],id:a,created_at:s,name:r,board:n,emails:l||[],unread:o||0,users:d||[],last_message:i,messages:u}}),t}if("ConversationResource"===s){let a=n||{},{id:t}=a,s={...e,data:{...e.data}};return t&&(s.data[t]={...s.data[t],...a}),s}if("NewsHubBadgeResource"===s&&n){let a=n.conversations_unseen_count||0;return{...e,unread:a}}}else if("MESSAGE_SEND_PENDING"===a.type){let{id:t,message:s}=a.payload;if(e.data[t])return{...e,data:{...e.data,[t]:{...e.data[t],id:t,messages:[...e.data[t].messages,s]}}}}else if("MESSAGE_SEND_PENDING_SUCCESS"===a.type){let{id:t,tempMessage:s,newMessage:r}=a.payload;if(e.data[t]&&u(e,t).find(e=>e.id===s.id&&e.created_ms===s.created_ms)){let a=E(c(u(e,t).filter(e=>e.id!==s.id).concat([r]),e=>e.id));return{...e,data:{...e.data,[t]:{...e.data[t],last_message:r,messages:a}}}}}else if("MESSAGE_SEND_PENDING_FAILURE"===a.type){let{id:t,tempMessageId:s}=a.payload;if(e.data[t]){let a=u(e,t).filter(e=>e.id!==s);return{...e,data:{...e.data,[t]:{...e.data[t],messages:a}}}}}else if("OPEN_NEW_MESSAGE"===a.type){let{objectAttachment:t}=a.payload||null;return{...e,showNewMessageView:!0,open:null,objectAttachment:t}}else if("CLOSE_DROPDOWN"===a.type)return{...e,showConversationsDropdown:!1,objectAttachment:null,showNewMessageView:!1};else if("OPEN_DROPDOWN"===a.type)return{...e,showConversationsDropdown:!0};else if("UPDATE_NEWSHUB_COUNT"===a.type)return{...e,newsHubCount:a.payload};else if("UPDATE_UNREAD_COUNT"===a.type)return{...e,conversationsUnseenCount:a.payload};else if("CLEAR_MESSAGE_BADGE"===a.type){let{id:t}=a.payload;return{...e,data:{...e.data,[t]:{...e.data[t],unread:0}}}}else if("CONVERSATION_SAVE_POSITION"===a.type){let{id:t,position:s}=a.payload;return{...e,data:{...e.data,[t]:{...e.data[t],position:s}}}}else if("CONVERSATION_RESET_POSITION"===a.type){let{id:t}=a.payload;return{...e,data:{...e.data,[t]:{...e.data[t],position:null}}}}else if("SET_OBJECT_ATTACHMENT"===a.type){let{objectAttachment:t}=a.payload;return{...e,objectAttachment:t}}else if("REMOVE_OBJECT_ATTACHMENT"===a.type)return{...e,objectAttachment:null};return e}var C=t(785893);let N=(s=0,()=>s++),{Provider:O,useHook:S}=(0,o.Z)("Conversations");function T({children:e}){let[a,t]=(0,r.useReducer)(y,p),s=(0,r.useCallback)(e=>t({type:"FETCH_COMPLETE",payload:e}),[]);(0,d.Z8)("ConversationMessagesResource",s),(0,d.my)("ConversationMessagesResource",s),(0,d.Z8)("ConversationsResource",s),(0,d.Z8)("ConversationResource",s),(0,d.Z8)("NewsHubBadgeResource",s);let l=(0,r.useCallback)((e,a=!1,s="")=>t({type:"CONVERSATION_OPEN",payload:{id:e,isPreview:a,contactRequestId:s}}),[]),o=(0,r.useCallback)((e,a="",s=!1)=>t({type:"CONVERSATION_CLOSE",payload:{id:e,contactRequestId:a,isDeclined:s}}),[]),i=(0,r.useCallback)(e=>t({type:"CONVERSATION_CREATE",payload:e}),[]),u=(0,r.useCallback)(e=>t({type:"CONVERSATION_DELETE",payload:{id:e}}),[]),c=(0,r.useCallback)((e,a)=>t({type:"CONVERSATION_SAVE_POSITION",payload:{id:e,position:a}}),[]),E=(0,r.useCallback)(e=>t({type:"CONVERSATION_RESET_POSITION",payload:{id:e}}),[]),_=(0,r.useCallback)((e,a,s)=>{n.Z.create("ConversationsResource",{user_ids:e,emails:a,text:""}).callCreate().then(e=>{t({type:"CONVERSATION_OPEN",payload:{id:(e&&e.resource_response.data).id}})}).catch(e=>{s(e.message_detail||e.message||"")})},[]),N=(0,r.useCallback)(()=>{t({type:"CLOSE_DROPDOWN"})},[]),S=(0,r.useCallback)(()=>{t({type:"OPEN_DROPDOWN"})},[]),T=(0,r.useCallback)(e=>{t({type:"OPEN_NEW_MESSAGE",payload:{objectAttachment:e}})},[]),A=(0,r.useCallback)((e,a)=>t({type:"MESSAGE_SEND_PENDING",payload:{id:e,message:a}}),[]),f=(0,r.useCallback)((e,a,s)=>t({type:"MESSAGE_SEND_PENDING_SUCCESS",payload:{id:e,tempMessage:a,newMessage:s}}),[]),R=(0,r.useCallback)((e,a)=>t({type:"MESSAGE_SEND_PENDING_FAILURE",payload:{id:e,tempMessageId:a}}),[]),D=(0,r.useCallback)(e=>t({type:"UPDATE_NEWSHUB_COUNT",payload:e}),[]),m=(0,r.useCallback)(e=>t({type:"UPDATE_UNREAD_COUNT",payload:e}),[]),w=(0,r.useCallback)(e=>t({type:"CLEAR_MESSAGE_BADGE",payload:{id:e}}),[]),g=(0,r.useCallback)(e=>t({type:"SET_OBJECT_ATTACHMENT",payload:{objectAttachment:e}}),[]),P=(0,r.useCallback)(()=>t({type:"REMOVE_OBJECT_ATTACHMENT"}),[]),I=(0,r.useMemo)(()=>({clearMessageBadge:w,conversationOpen:l,conversationClose:o,conversationCreate:i,conversationDelete:u,conversationGet:_,saveConversationPosition:c,resetConversationPosition:E,dropdownClose:N,dropdownOpen:S,newMessageOpen:T,pendingMessageSend:A,pendingMessageSuccess:f,pendingMessageFailure:R,updateNewsHubCount:D,updateUnreadCount:m,conversations:a,setObjectAttachment:g,removeObjectAttachment:P}),[w,l,o,i,u,_,c,E,N,S,T,A,f,R,D,m,a,g,P]);return(0,C.jsx)(O,{value:I,children:e})}function A(){let{conversationCreate:e}=S();return async a=>{let t;let s=n.Z.create("ConversationsResource",a);try{let a=(await s.callCreate()).resource_response.data;a&&(e(a),t=a)}catch(e){throw Error(e.message)}return t}}function f(){let{conversations:e,conversationCreate:a,pendingMessageSend:t,pendingMessageSuccess:s,pendingMessageFailure:r}=S(),o=(0,l.Z)();return async(l,d,i,u)=>{let{text:c,pinId:E,boardId:_,userId:p,didItId:y}=d;async function C(){let e=n.Z.create("ConversationMessagesResource",{conversation_id:l,text:c,pin:E,board:_,user:p,user_did_it_data:y,source:i,client_tracking_params:o(E??"")}),a=`${N()}`,d={text:c,sender:u,created_at:new Date().toString(),created_ms:Date.now(),id:a,type:"tempMessage"};t(l,d);try{let a=(await e.callCreate()).resource_response.data;a&&s(l,d,a)}catch(e){throw r(l,a),Error(e.message)}}if(e.data[l])await C();else{let e=n.Z.create("ConversationResource",{conversation_id:l});try{let t=(await e.callGet()).resource_response.data;t&&(a(t),await C())}catch(e){throw Error(e.message)}}}}function R(e){let{conversations:a}=S();return a.data[e]}function D(e){let{conversations:a}=S();return a.ui[e]||{contactRequestId:"",isDeclined:!1,isPreview:!1}}function m(){let{conversations:{data:e}}=S();return Array.from(Object.keys(e).map(a=>e[a]).filter(e=>e.users&&e.last_message)).sort((e,a)=>new Date((a.last_message||a).created_at).getTime()-new Date((e.last_message||e).created_at).getTime())}}}]);
//# sourceMappingURL=https://sm.pinimg.com/webapp/61672-f6b40c651888631f.mjs.map